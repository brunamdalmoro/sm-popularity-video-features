---
title: "Predicting Number of Views - Exploring"
author: "Bruna Martini Dalmoro"
output:
  html_document:
    code_folding: hide
    keep_md: yes
---

```{r setup, include=FALSE, echo=FALSE, message=FALSE}
# Chunck options default
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

# Options (remove scientific notation)
options(scipen = 999, qwraps2_markup = 'markdown')

# Seed
set.seed(1234)

library(tidyverse)  # Clean, process, model, and visualize data
library(hrbrthemes) # Theme plots
library(qwraps2)    # Beautiful descriptive tables
library(factoextra) # PCA Analisys
library(rpart)      # Decision Trees
library(rpart.plot) # Decision Trees
library(randomForest) # Random Forest Models
library(caret)      # Cross Validation
library(ROCR)       # ROC curve

source("../scripts/functions/model_metrics.R") # Accuracy, Precision, Recal and F1

```

# Initial exploratory data analysis

In this project we use a dataset containing visual and temporal features from 1820 videos uploaded to facebook between August 1st, 2015 until October 15th, 2015 collected by Trzci´nski and Rokita and the data are available in <http://ii.pw.edu.pl/~ttrzcins/facebook_dataset_2015.csv>.

Our focus is on analysing the visual features, looking for some clue about the relationship between these visual features and the video popularity.


```{r reading-data}
# Reading original data
facebook_data <- read_rds("../data/raw/facebook_dataset.rds")

# Reading original data splitted in visual and temporal features
visual_features <- read_rds("../data/processed/visual_features.rds")
temporal_features <- read_rds("../data/processed/temporal_features.rds")

# Reading temporal features data in long format
temporal_features_long <- read_rds("../data/processed/temporal_features_long.rds")

# Reading the final dataset: all visual features and the target feature
visual_96 <- read_rds("../data/processed/visual_features_96h.rds")
```


## Exploring data

### Visual Features

Exploring visual features from dataset.

```{r data-structure-visual-features}
# Structure of data
glimpse(visual_features)
```


( Gráficos explorando as features aqui! ) ?


```{r summary_visual_features, results='asis'}
# Summary tables
visual_features %>% select(-facebook_post_id) %>% summary_table(.)
```

### Temporal/social features

Choosing the model target.

```{r choosing-time}
# Choosing the time of number of views to preditc
temporal_features_long %>%
  filter(feature == "views") %>% 
  group_by(time) %>%
  summarise( m_views = mean(value) ) %>%
  ungroup() %>%
  ggplot(aes(x = as.numeric(time), y = m_views, group = 1)) +
  geom_line() +
  geom_vline(aes(xintercept = 96), colour = "#BB0000", linetype = "dashed") +
  annotate(geom = "text", x = 92, y = 750000, label = "96h",
           colour = "#BB0000", size = 3) +
  labs(x = "Time after publication (hours)", y = "Mean of Views", 
       title = "Evolution of Video Views") +
  theme_ipsum()
```


```{r response-distribution}
visual_96 %>%
  ggplot(aes(x = 1, y = (views_96))) +
  geom_boxplot()
```


### Exploring correlation with predictor features

```{r correlations}
# General
cor.test(visual_96$general.duration, visual_96$views_96)
cor.test(visual_96$general.fps, visual_96$views_96)
cor.test(visual_96$general.frame_count, visual_96$views_96)
cor.test(visual_96$general.frame_size.height, visual_96$views_96)
cor.test(visual_96$general.frame_size.width, visual_96$views_96)

# Colors
cor.test(visual_96$dominant_color.histogram_0, visual_96$views_96)
cor.test(visual_96$dominant_color.histogram_1, visual_96$views_96)
cor.test(visual_96$dominant_color.histogram_2, visual_96$views_96)
cor.test(visual_96$dominant_color.histogram_3, visual_96$views_96)
cor.test(visual_96$dominant_color.histogram_4, visual_96$views_96)
cor.test(visual_96$dominant_color.histogram_5, visual_96$views_96)
cor.test(visual_96$dominant_color.histogram_6, visual_96$views_96)
cor.test(visual_96$dominant_color.histogram_7, visual_96$views_96)
cor.test(visual_96$dominant_color.histogram_8, visual_96$views_96)
cor.test(visual_96$dominant_color.histogram_9, visual_96$views_96)

# Face
cor.test(visual_96$face_detection.average_face2frame_ratio, visual_96$views_96)
cor.test(visual_96$face_detection.average_face_count_per_frame, visual_96$views_96)
cor.test(visual_96$face_detection.average_face_present, visual_96$views_96)

# Text
cor.test(visual_96$text_detection.average_text2frame_ratio, visual_96$views_96)
cor.test(visual_96$text_detection.average_text_frames, visual_96$views_96)

# Shot
cor.test(visual_96$shot_detection.average_shot_length, visual_96$views_96)
cor.test(visual_96$shot_detection.shots_count, visual_96$views_96)
cor.test(visual_96$shot_detection.transition_histogram_0, visual_96$views_96)
cor.test(visual_96$shot_detection.transition_histogram_1, visual_96$views_96)

# Other
cor.test(visual_96$other.average_movie_speed, visual_96$views_96)
cor.test(visual_96$other.clutter_metric, visual_96$views_96)
cor.test(visual_96$rigidity.average_rigidity, visual_96$views_96)

cor(visual_96 %>% select(-facebook_post_id,-dominant_color.value))
```

# Initial modeling

## Linear models

```{r fit-linear-models}
## Each feature
# General
lm(visual_96$views_96 ~ visual_96$general.duration) %>% summary()
lm(visual_96$views_96 ~ visual_96$general.fps) %>% summary()
lm(visual_96$views_96 ~ visual_96$general.frame_count) %>% summary()
lm(visual_96$views_96 ~ visual_96$general.frame_size.height) %>% summary()
lm(visual_96$views_96 ~ visual_96$general.frame_size.width) %>% summary()

# Color
lm(visual_96$views_96 ~ visual_96$dominant_color.histogram_0) %>% summary()
lm(visual_96$views_96 ~ visual_96$dominant_color.histogram_1) %>% summary()
lm(visual_96$views_96 ~ visual_96$dominant_color.histogram_2) %>% summary()
lm(visual_96$views_96 ~ visual_96$dominant_color.histogram_3) %>% summary()
lm(visual_96$views_96 ~ visual_96$dominant_color.histogram_4) %>% summary()
lm(visual_96$views_96 ~ visual_96$dominant_color.histogram_5) %>% summary()
lm(visual_96$views_96 ~ visual_96$dominant_color.histogram_6) %>% summary()
lm(visual_96$views_96 ~ visual_96$dominant_color.histogram_7) %>% summary()
lm(visual_96$views_96 ~ visual_96$dominant_color.histogram_8) %>% summary()
lm(visual_96$views_96 ~ visual_96$dominant_color.histogram_9) %>% summary()
lm(visual_96$views_96 ~ visual_96$dominant_color.value) %>% summary()

# Face
lm(visual_96$views_96 ~ visual_96$face_detection.average_face2frame_ratio) %>% summary()
lm(visual_96$views_96 ~ visual_96$face_detection.average_face_count_per_frame) %>% summary()
lm(visual_96$views_96 ~ visual_96$face_detection.average_face_present) %>% summary()

# Text
lm(visual_96$views_96 ~ visual_96$text_detection.average_text2frame_ratio) %>% summary()
lm(visual_96$views_96 ~ visual_96$text_detection.average_text_frames) %>% summary()

# Shot
lm(visual_96$views_96 ~ visual_96$shot_detection.average_shot_length) %>% summary()
lm(visual_96$views_96 ~ visual_96$shot_detection.shots_count) %>% summary()
lm(visual_96$views_96 ~ visual_96$shot_detection.transition_histogram_0) %>% summary()
lm(visual_96$views_96 ~ visual_96$shot_detection.transition_histogram_1) %>% summary()

# Other
lm(visual_96$views_96 ~ visual_96$other.average_movie_speed) %>% summary()
lm(visual_96$views_96 ~ visual_96$other.clutter_metric) %>% summary()
lm(visual_96$views_96 ~ visual_96$rigidity.average_rigidity) %>% summary()

## Groupin features
lm(visual_96$views_96 ~ 
       visual_96$general.duration +
       visual_96$general.fps +
       visual_96$general.frame_count +
       visual_96$general.frame_size.height) %>% summary()

lm(visual_96$views_96 ~ 
       visual_96$dominant_color.histogram_0 +
       visual_96$dominant_color.histogram_1 +
       visual_96$dominant_color.histogram_2 +
       visual_96$dominant_color.histogram_3 +
       visual_96$dominant_color.histogram_4 +
       visual_96$dominant_color.histogram_5 +
       visual_96$dominant_color.histogram_6 +
       visual_96$dominant_color.histogram_7 +
       visual_96$dominant_color.histogram_8 +
       visual_96$dominant_color.histogram_9 +
       visual_96$dominant_color.value) %>% summary()

lm(visual_96$views_96 ~ 
      visual_96$face_detection.average_face2frame_ratio + 
      visual_96$face_detection.average_face_count_per_frame + 
      visual_96$face_detection.average_face_present) %>% summary()

lm(visual_96$views_96 ~ 
      visual_96$text_detection.average_text2frame_ratio +
      visual_96$text_detection.average_text_frames) %>% summary()

lm(visual_96$views_96 ~ 
      visual_96$shot_detection.average_shot_length + 
      visual_96$shot_detection.shots_count + 
      visual_96$shot_detection.transition_histogram_0 + 
      visual_96$shot_detection.transition_histogram_1) %>% summary()

lm(visual_96$views_96 ~ 
     visual_96$other.average_movie_speed +
     visual_96$other.clutter_metric +
     visual_96$rigidity.average_rigidity) %>% summary()


## All features
lm(visual_96$views_96 ~ 
      visual_96$general.duration +
      visual_96$general.fps +
      visual_96$general.frame_count +
      visual_96$general.frame_size.height +
      visual_96$dominant_color.histogram_0 +
      visual_96$dominant_color.histogram_1 +
      visual_96$dominant_color.histogram_2 +
      visual_96$dominant_color.histogram_3 +
      visual_96$dominant_color.histogram_4 +
      visual_96$dominant_color.histogram_5 +
      visual_96$dominant_color.histogram_6 +
      visual_96$dominant_color.histogram_7 +
      visual_96$dominant_color.histogram_8 +
      visual_96$dominant_color.histogram_9 +
      visual_96$dominant_color.value +
      visual_96$face_detection.average_face2frame_ratio + 
      visual_96$face_detection.average_face_count_per_frame + 
      visual_96$face_detection.average_face_present +
      visual_96$text_detection.average_text2frame_ratio +
      visual_96$text_detection.average_text_frames +
      visual_96$shot_detection.average_shot_length + 
      visual_96$shot_detection.shots_count + 
      visual_96$shot_detection.transition_histogram_0 + 
      visual_96$shot_detection.transition_histogram_1 +
      visual_96$other.average_movie_speed +
      visual_96$other.clutter_metric +
      visual_96$rigidity.average_rigidity) %>% summary()

## Selected features
lm(visual_96$views_96 ~ -1 +
      visual_96$general.duration +
      visual_96$general.fps +
      # visual_96$general.frame_count +
      visual_96$general.frame_size.height +
      # visual_96$dominant_color.histogram_0 +
      # visual_96$dominant_color.histogram_1 +
      # visual_96$dominant_color.histogram_2 +
      visual_96$dominant_color.histogram_3 +
      # visual_96$dominant_color.histogram_4 +
      # visual_96$dominant_color.histogram_5 +
      # visual_96$dominant_color.histogram_6 +
      visual_96$dominant_color.histogram_7 +
      # visual_96$dominant_color.histogram_8 +
      # visual_96$dominant_color.histogram_9 +
      # visual_96$dominant_color.value +
      # visual_96$face_detection.average_face2frame_ratio + 
      # visual_96$face_detection.average_face_count_per_frame + 
      # visual_96$face_detection.average_face_present +
      # visual_96$text_detection.average_text2frame_ratio +
      visual_96$text_detection.average_text_frames +
      # visual_96$shot_detection.average_shot_length + 
      # visual_96$shot_detection.shots_count + 
      # visual_96$shot_detection.transition_histogram_0 + 
      # visual_96$shot_detection.transition_histogram_1 +
      # visual_96$other.average_movie_speed +
      # visual_96$other.clutter_metric +
      visual_96$rigidity.average_rigidity) %>% summary()

```


# Categorizing the target

```{r categorical-response}
# All features and responses
visual_resp <- visual_96 %>%
  mutate(
    quartis = ntile(visual_96$views_96,4) %>% as.factor(),
    quartil_4 = ifelse(quartis == 4, 1, 0) %>% as.factor(),
    maior_1m = ifelse(views_96 >= 1000000, 1, 0) %>% as.factor(),
    maior_500k = ifelse(views_96 >= 500000, 1, 0) %>% as.factor(),
    tres_partes = ifelse(views_96 >= 1000000, "> 1m", 
                         ifelse(views_96 < 1000000 & views_96 >= 500000, "> 500k", "Menor")) %>% as.factor()
  )

```

# Split dataset 

```{r split-dataset-train-teste}
train <- visual_resp %>% sample_frac(.70)
test  <- anti_join(visual_resp, train, by = 'facebook_post_id')
```

# Decision trees

### Árvores de decisão para variável resposta "quartil" onde cada quartil é uma categoria.

```{r decision-tree-quartis}

tree_general = rpart(quartis ~ -1 +
                     general.duration +
                     general.fps +
                     general.frame_count +
                     general.frame_size.height, data=train, method = 'class')
rpart.plot(tree_general)


tree_color = rpart(quartis ~ 
                     dominant_color.histogram_0 +
                     dominant_color.histogram_1 +
                     dominant_color.histogram_2 +
                     dominant_color.histogram_3 +
                     dominant_color.histogram_4 +
                     dominant_color.histogram_5 +
                     dominant_color.histogram_6 +
                     dominant_color.histogram_7 +
                     dominant_color.histogram_8 +
                     dominant_color.histogram_9 +
                     dominant_color.value, data=train, method = 'class')
rpart.plot(tree_color)

tree_face = rpart(quartis ~ 
                    face_detection.average_face2frame_ratio + 
                    face_detection.average_face_count_per_frame + 
                    face_detection.average_face_present, data=train, method = 'class')

rpart.plot(tree_face)

tree_text = rpart(quartis ~ 
                    text_detection.average_text2frame_ratio +
                    text_detection.average_text_frames, data=train, method = 'class')
rpart.plot(tree_text)


tree_shot = rpart(quartis ~ 
                    shot_detection.average_shot_length + 
                    shot_detection.shots_count + 
                    shot_detection.transition_histogram_0 + 
                    shot_detection.transition_histogram_1, data=train, method = 'class')

rpart.plot(tree_shot)


tree_other = rpart(quartis ~ 
                     other.average_movie_speed +
                     other.clutter_metric +
                     rigidity.average_rigidity, data=train, method = 'class')

rpart.plot(tree_other)

```

### Árvores de decisão para variável resposta "está no quarto quartil".

```{r decision-tree-4-quartil}

tree_general_4 = rpart(quartil_4 ~ 
                     general.duration +
                     general.fps +
                     general.frame_count +
                     general.frame_size.height, data=train, method = 'class')
rpart.plot(tree_general_4)

tree_color_4 = rpart(quartil_4 ~ 
                     dominant_color.histogram_0 +
                     dominant_color.histogram_1 +
                     dominant_color.histogram_2 +
                     dominant_color.histogram_3 +
                     dominant_color.histogram_4 +
                     dominant_color.histogram_5 +
                     dominant_color.histogram_6 +
                     dominant_color.histogram_7 +
                     dominant_color.histogram_8 +
                     dominant_color.histogram_9 +
                     dominant_color.value, data=train, method = 'class')
rpart.plot(tree_color_4)

tree_face_4 = rpart(quartil_4 ~ 
                    face_detection.average_face2frame_ratio + 
                    face_detection.average_face_count_per_frame + 
                    face_detection.average_face_present, data=train, method = 'class')

rpart.plot(tree_face_4)

tree_text_4 = rpart(quartil_4 ~ 
                    text_detection.average_text2frame_ratio +
                    text_detection.average_text_frames, data=train, method = 'class')
rpart.plot(tree_text_4)


tree_shot_4 = rpart(quartil_4 ~ 
                    shot_detection.average_shot_length + 
                    shot_detection.shots_count + 
                    shot_detection.transition_histogram_0 + 
                    shot_detection.transition_histogram_1, data=train, method = 'class')
rpart.plot(tree_shot_4)


tree_other_4 = rpart(quartil_4 ~ 
                     other.average_movie_speed +
                     other.clutter_metric +
                     rigidity.average_rigidity, data=train, method = 'class')
rpart.plot(tree_other_4)

```

### Árvores de decisão para variável resposta "maior que 1 milhão de views".

```{r decision-tree-maior-1m}

tree_general_1m = rpart(maior_1m ~ 
                     general.duration +
                     general.fps +
                     general.frame_count +
                     general.frame_size.height, data=train, method = 'class')
rpart.plot(tree_general_1m)

tree_color_1m = rpart(maior_1m ~ 
                     dominant_color.histogram_0 +
                     dominant_color.histogram_1 +
                     dominant_color.histogram_2 +
                     dominant_color.histogram_3 +
                     dominant_color.histogram_4 +
                     dominant_color.histogram_5 +
                     dominant_color.histogram_6 +
                     dominant_color.histogram_7 +
                     dominant_color.histogram_8 +
                     dominant_color.histogram_9 +
                     dominant_color.value, data=train, method = 'class')
rpart.plot(tree_color_1m)

tree_face_1m = rpart(maior_1m ~ 
                    face_detection.average_face2frame_ratio + 
                    face_detection.average_face_count_per_frame + 
                    face_detection.average_face_present, data=train, method = 'class')
rpart.plot(tree_face_1m)

tree_text_1m = rpart(maior_1m ~ 
                    text_detection.average_text2frame_ratio +
                    text_detection.average_text_frames, data=train, method = 'class')
rpart.plot(tree_text_1m)


tree_shot_1m = rpart(maior_1m ~ 
                    shot_detection.average_shot_length + 
                    shot_detection.shots_count + 
                    shot_detection.transition_histogram_0 + 
                    shot_detection.transition_histogram_1, data=train, method = 'class')
rpart.plot(tree_shot_1m)


tree_other_1m = rpart(maior_1m ~ 
                     other.average_movie_speed +
                     other.clutter_metric +
                     rigidity.average_rigidity, data=train, method = 'class')
rpart.plot(tree_other_1m)

```

# Modeling

## Random Forest

### Testando com a variável resposta "quartis", conde cada quartil é uma categoria.

```{r random-forests-quartis}
# Create a Random Forest model with default parameters
model_default_quartis <- randomForest(quartis ~ 
                         general.duration +
                         general.fps +
                         general.frame_count +
                         general.frame_size.height+
                         dominant_color.histogram_0 +
                         dominant_color.histogram_1 +
                         dominant_color.histogram_2 +
                         dominant_color.histogram_3 +
                         dominant_color.histogram_4 +
                         dominant_color.histogram_5 +
                         dominant_color.histogram_6 +
                         dominant_color.histogram_7 +
                         dominant_color.histogram_8 +
                         dominant_color.histogram_9 +
                         dominant_color.value +
                         face_detection.average_face2frame_ratio + 
                         face_detection.average_face_count_per_frame + 
                         face_detection.average_face_present+
                         text_detection.average_text2frame_ratio +
                         text_detection.average_text_frames+
                         shot_detection.average_shot_length + 
                         shot_detection.shots_count + 
                         shot_detection.transition_histogram_0 + 
                         shot_detection.transition_histogram_1+
                         other.average_movie_speed +
                         other.clutter_metric +
                         rigidity.average_rigidity, data = train, importance = TRUE)
model_default_quartis

# To check important variables
importance(model_default_quartis)        
varImpPlot(model_default_quartis)

# Predicting on train set
predTrain_quartis <- predict(model_default_quartis, train, type = "class")
# Checking classification accuracy
table(predTrain_quartis, train$quartis)  


# Predicting on test set
predValid_quartis <- predict(model_default_quartis, test, type = "class")
# Checking classification accuracy
table(predValid_quartis, test$quartis)
mean(predValid_quartis == test$quartis)
```

### Testando com a variável resposta "estar no quarto quartil".

```{r random-forests-quartil4}
# Create a Random Forest model with default parameters
model_default_quartil4 <- randomForest(quartil_4 ~ 
                         general.duration +
                         general.fps +
                         general.frame_count +
                         general.frame_size.height+
                         dominant_color.histogram_0 +
                         dominant_color.histogram_1 +
                         dominant_color.histogram_2 +
                         dominant_color.histogram_3 +
                         dominant_color.histogram_4 +
                         dominant_color.histogram_5 +
                         dominant_color.histogram_6 +
                         dominant_color.histogram_7 +
                         dominant_color.histogram_8 +
                         dominant_color.histogram_9 +
                         dominant_color.value +
                         face_detection.average_face2frame_ratio + 
                         face_detection.average_face_count_per_frame + 
                         face_detection.average_face_present+
                         text_detection.average_text2frame_ratio +
                         text_detection.average_text_frames+
                         shot_detection.average_shot_length + 
                         shot_detection.shots_count + 
                         shot_detection.transition_histogram_0 + 
                         shot_detection.transition_histogram_1+
                         other.average_movie_speed +
                         other.clutter_metric +
                         rigidity.average_rigidity, data = train, importance = TRUE)
model_default_quartil4

# To check important variables
importance(model_default_quartil4)        
varImpPlot(model_default_quartil4)

# Predicting on train set
predTrain_quartil4 <- predict(model_default_quartil4, train, type = "class")
# Checking classification accuracy
table(predTrain_quartil4, train$quartil_4)


# Predicting on test set
predValid_quartil4 <- predict(model_default_quartil4, test, type = "class")
# Checking classification accuracy
table(predValid_quartil4, test$quartil_4)  
mean(predValid_quartil4 == test$quartil_4)
```

### Testando com a variável resposta sendo "mais de 500 mil views".

```{r random-forests}
# Create a Random Forest model with default parameters
model_random_forest <- randomForest(maior_500k ~ 
                         general.duration +
                         general.fps +
                         general.frame_count +
                         general.frame_size.height+
                         dominant_color.histogram_0 +
                         dominant_color.histogram_1 +
                         dominant_color.histogram_2 +
                         dominant_color.histogram_3 +
                         dominant_color.histogram_4 +
                         dominant_color.histogram_5 +
                         dominant_color.histogram_6 +
                         dominant_color.histogram_7 +
                         dominant_color.histogram_8 +
                         dominant_color.histogram_9 +
                         dominant_color.value +
                         face_detection.average_face2frame_ratio + 
                         face_detection.average_face_count_per_frame + 
                         face_detection.average_face_present+
                         text_detection.average_text2frame_ratio +
                         text_detection.average_text_frames+
                         shot_detection.average_shot_length + 
                         shot_detection.shots_count + 
                         shot_detection.transition_histogram_0 + 
                         shot_detection.transition_histogram_1+
                         other.average_movie_speed +
                         other.clutter_metric +
                         rigidity.average_rigidity, data = train, importance = TRUE)
# model_random_forest
# 
# # To check important variables
# importance(model_random_forest)      
# varImpPlot(model_random_forest)

# Predicting on test set
test_pred_random_forest <- predict(model_random_forest, test, type = "class")

# Checking classification metrics
confusion_matrix_random_forest <- table(test_pred_random_forest, test$maior_500k)
confusion_matrix_random_forest

metrics(confusion_matrix_random_forest)
```


### Variable selection

A princípio, o modelo default que mais se saiu bem foi o que utiliza a variável resposta como sendo o vídeo ter mais de 1 milhão de views.

Abaixo o teste fazendo uma seleção manual de variáveis.

```{r random-forests-testing}

# Create a Random Forest model with default parameters
model_rf_selection <- randomForest(maior_500k ~ 
                         general.duration +
                         general.fps +
                         general.frame_count +
                         general.frame_size.height+
                         # dominant_color.histogram_0 +
                         # dominant_color.histogram_1 +
                         dominant_color.histogram_2 +
                         # dominant_color.histogram_3 +
                         # dominant_color.histogram_4 +
                         # dominant_color.histogram_5 +
                         # dominant_color.histogram_6 +
                         dominant_color.histogram_7 +
                         # dominant_color.histogram_8 +
                         # dominant_color.histogram_9 +
                         dominant_color.value +
                         face_detection.average_face2frame_ratio + 
                         face_detection.average_face_count_per_frame + 
                         face_detection.average_face_present+
                         text_detection.average_text2frame_ratio +
                         text_detection.average_text_frames+
                         shot_detection.average_shot_length + 
                         shot_detection.shots_count +
                         # shot_detection.transition_histogram_0 + 
                         # shot_detection.transition_histogram_1 +
                         # other.average_movie_speed +
                         other.clutter_metric +
                         rigidity.average_rigidity, data = train, 
                         importance = TRUE, mtry = 6)
# model_rf_selection
# 
# # To check important variables
# importance(model_rf_selection)
# varImpPlot(model_rf_selection)

# Predicting on test set
test_pred_rf_selecion <- predict(model_rf_selection, test, type = "class")

# Checking classification metrics
confusion_matrix_rf_selecion <- table(test_pred_rf_selecion, test$maior_500k)
confusion_matrix_rf_selecion

metrics(confusion_matrix_rf_selecion)
```

## Cross validation

Agora, tunando o parâmetro mtry da Random Forest e utilizando croos validation com k = 5 folders.

```{r cross-validation}

# 5 folds
tr <- trainControl(method = "cv", number = 5)

model_rf_crossvalidation <- train(maior_500k ~ 
                         general.duration +
                         general.fps +
                         general.frame_count +
                         general.frame_size.height +
                         # dominant_color.histogram_0 +
                         # dominant_color.histogram_1 +
                         # dominant_color.histogram_2 +
                         dominant_color.histogram_3 +
                         # dominant_color.histogram_4 +
                         # dominant_color.histogram_5 +
                         # dominant_color.histogram_6 +
                         dominant_color.histogram_7 +
                         # dominant_color.histogram_8 +
                         # dominant_color.histogram_9 +
                         # dominant_color.value +
                         face_detection.average_face2frame_ratio + 
                         face_detection.average_face_count_per_frame + 
                         face_detection.average_face_present +
                         text_detection.average_text2frame_ratio +
                         text_detection.average_text_frames +
                         shot_detection.average_shot_length + 
                         shot_detection.shots_count +
                         # shot_detection.transition_histogram_0 +
                         # shot_detection.transition_histogram_1 +
                         # other.average_movie_speed +
                         other.clutter_metric +
                         rigidity.average_rigidity,
                         data = train, method = "rf", trControl = tr)

# model_rf_crossvalidation
# 
# 
# # To check important variables
# importance(model_rf_crossvalidation$finalModel)
varImpPlot(model_rf_crossvalidation$finalModel)

# Predicting on test set
test_pred_rf_crossvalidation <- predict(model_rf_crossvalidation$finalModel, test, type = "class")

# Checking classification metrics
confusion_matrix_rf_crossvalidation <- table(test_pred_rf_crossvalidation, test$maior_500k)  
confusion_matrix_rf_crossvalidation

metrics(confusion_matrix_rf_crossvalidation)

```

### Paper technique

```{r paper-technique}

# Support Vector Machine Radial
model_cv_svm_radial <- train(maior_500k ~ 
                         general.duration +
                         general.fps +
                         general.frame_count +
                         general.frame_size.height +
                         # dominant_color.histogram_0 +
                         # dominant_color.histogram_1 +
                         # dominant_color.histogram_2 +
                         dominant_color.histogram_3 +
                         # dominant_color.histogram_4 +
                         # dominant_color.histogram_5 +
                         # dominant_color.histogram_6 +
                         dominant_color.histogram_7 +
                         # dominant_color.histogram_8 +
                         # dominant_color.histogram_9 +
                         # dominant_color.value +
                         face_detection.average_face2frame_ratio + 
                         face_detection.average_face_count_per_frame + 
                         face_detection.average_face_present +
                         text_detection.average_text2frame_ratio +
                         text_detection.average_text_frames +
                         shot_detection.average_shot_length + 
                         shot_detection.shots_count +
                         # shot_detection.transition_histogram_0 + 
                         # shot_detection.transition_histogram_1 +
                         # other.average_movie_speed +
                         other.clutter_metric +
                         rigidity.average_rigidity,
                         data = train, method = "svmRadial", trControl = tr)

# model_cv_svm_radial


# Predicting o test set
test_pred_svm_radial <- predict(model_cv_svm_radial, test)

# Checking classification metrics
confusion_matrix_svm_radial <- confusionMatrix(test_pred_svm_radial, test$maior_500k)
confusion_matrix_svm_radial

metrics(as.matrix(confusion_matrix_svm_radial$table))


```

### Other models

Ajustando outros modelos de machine larning para comparação.

```{r cross-validation-outros}
# Support Vector Machine Linear
model_cv_svm_linear <- train(maior_500k ~ 
                         general.duration +
                         general.fps +
                         general.frame_count +
                         general.frame_size.height +
                         # dominant_color.histogram_0 +
                         # dominant_color.histogram_1 +
                         # dominant_color.histogram_2 +
                         dominant_color.histogram_3 +
                         # dominant_color.histogram_4 +
                         # dominant_color.histogram_5 +
                         # dominant_color.histogram_6 +
                         dominant_color.histogram_7 +
                         # dominant_color.histogram_8 +
                         # dominant_color.histogram_9 +
                         # dominant_color.value +
                         face_detection.average_face2frame_ratio + 
                         face_detection.average_face_count_per_frame + 
                         face_detection.average_face_present +
                         text_detection.average_text2frame_ratio +
                         text_detection.average_text_frames +
                         shot_detection.average_shot_length + 
                         shot_detection.shots_count +
                         # shot_detection.transition_histogram_0 + 
                         # shot_detection.transition_histogram_1 +
                         # other.average_movie_speed +
                         other.clutter_metric +
                         rigidity.average_rigidity,
                         data = train, method = "svmLinear", trControl = tr)

# model_cv_svm_linear

# Predicting on test set
test_pred_svm_linear <- predict(model_cv_svm_linear, test)
# Checking classification metrics

confusion_matrix_svm_linear <- confusionMatrix(test_pred_svm_linear, test$maior_500k)
confusion_matrix_svm_linear

metrics(as.matrix(confusion_matrix_svm_linear$table))



# # Tree Bag
# model_crossvalidation_treebag <- train(maior_1m ~
#                          general.duration +
#                          general.fps +
#                          general.frame_count +
#                          general.frame_size.height +
#                          # dominant_color.histogram_0 +
#                          # dominant_color.histogram_1 +
#                          # dominant_color.histogram_2 +
#                          dominant_color.histogram_3 +
#                          # dominant_color.histogram_4 +
#                          # dominant_color.histogram_5 +
#                          # dominant_color.histogram_6 +
#                          dominant_color.histogram_7 +
#                          # dominant_color.histogram_8 +
#                          # dominant_color.histogram_9 +
#                          # dominant_color.value +
#                          face_detection.average_face2frame_ratio +
#                          face_detection.average_face_count_per_frame +
#                          face_detection.average_face_present +
#                          text_detection.average_text2frame_ratio +
#                          text_detection.average_text_frames +
#                          shot_detection.average_shot_length +
#                          shot_detection.shots_count +
#                          # shot_detection.transition_histogram_0 +
#                          # shot_detection.transition_histogram_1 +
#                          # other.average_movie_speed +
#                          other.clutter_metric +
#                          rigidity.average_rigidity,
#                          data = train, method = "treebag", trControl = tr)
# 
# model_crossvalidation_treebag
```



### Testando com a variável resposta sendo "mais de 1 milhão de views".

```{r random-forests2}
# Create a Random Forest model with default parameters
model_random_forest <- randomForest(maior_1m ~ 
                         general.duration +
                         general.fps +
                         general.frame_count +
                         general.frame_size.height+
                         dominant_color.histogram_0 +
                         dominant_color.histogram_1 +
                         dominant_color.histogram_2 +
                         dominant_color.histogram_3 +
                         dominant_color.histogram_4 +
                         dominant_color.histogram_5 +
                         dominant_color.histogram_6 +
                         dominant_color.histogram_7 +
                         dominant_color.histogram_8 +
                         dominant_color.histogram_9 +
                         # dominant_color.value +
                         face_detection.average_face2frame_ratio + 
                         face_detection.average_face_count_per_frame + 
                         face_detection.average_face_present+
                         text_detection.average_text2frame_ratio +
                         text_detection.average_text_frames+
                         shot_detection.average_shot_length + 
                         shot_detection.shots_count + 
                         shot_detection.transition_histogram_0 + 
                         shot_detection.transition_histogram_1+
                         other.average_movie_speed +
                         other.clutter_metric +
                         rigidity.average_rigidity, data = train, importance = TRUE)
# model_random_forest
# 
# # To check important variables
# importance(model_random_forest)      
# varImpPlot(model_random_forest)

# Predicting on test set
test_pred_random_forest <- predict(model_random_forest, test, type = "class")

# Checking classification metrics
confusion_matrix_random_forest <- table(test_pred_random_forest, test$maior_1m)
confusion_matrix_random_forest

metrics(confusion_matrix_random_forest)
```


### Variable selection

A princípio, o modelo default que mais se saiu bem foi o que utiliza a variável resposta como sendo o vídeo ter mais de 1 milhão de views.

Abaixo o teste fazendo uma seleção manual de variáveis.

```{r random-forests-testing2}

# Create a Random Forest model with default parameters
model_rf_selection <- randomForest(maior_1m ~ 
                         general.duration +
                         general.fps +
                         general.frame_count +
                         general.frame_size.height+
                         # dominant_color.histogram_0 +
                         # dominant_color.histogram_1 +
                         dominant_color.histogram_2 +
                         # dominant_color.histogram_3 +
                         # dominant_color.histogram_4 +
                         # dominant_color.histogram_5 +
                         # dominant_color.histogram_6 +
                         dominant_color.histogram_7 +
                         # dominant_color.histogram_8 +
                         # dominant_color.histogram_9 +
                         dominant_color.value +
                         face_detection.average_face2frame_ratio + 
                         face_detection.average_face_count_per_frame + 
                         face_detection.average_face_present+
                         text_detection.average_text2frame_ratio +
                         text_detection.average_text_frames+
                         shot_detection.average_shot_length + 
                         shot_detection.shots_count +
                         # shot_detection.transition_histogram_0 + 
                         # shot_detection.transition_histogram_1 +
                         # other.average_movie_speed +
                         other.clutter_metric +
                         rigidity.average_rigidity, data = train, 
                         importance = TRUE, mtry = 6)
# model_rf_selection
# 
# # To check important variables
# importance(model_rf_selection)
# varImpPlot(model_rf_selection)

# Predicting on test set
test_pred_rf_selecion <- predict(model_rf_selection, test, type = "class")

# Checking classification metrics
confusion_matrix_rf_selecion <- table(test_pred_rf_selecion, test$maior_1m)
confusion_matrix_rf_selecion

metrics(confusion_matrix_rf_selecion)
```

## Cross validation

Agora, tunando o parâmetro mtry da Random Forest e utilizando croos validation com k = 5 folders.

```{r cross-validation2}

# 5 folds
tr <- trainControl(method = "cv", number = 5)

model_rf_crossvalidation <- train(maior_1m ~ 
                         general.duration +
                         general.fps +
                         general.frame_count +
                         general.frame_size.height +
                         # dominant_color.histogram_0 +
                         # dominant_color.histogram_1 +
                         # dominant_color.histogram_2 +
                         dominant_color.histogram_3 +
                         # dominant_color.histogram_4 +
                         # dominant_color.histogram_5 +
                         # dominant_color.histogram_6 +
                         dominant_color.histogram_7 +
                         # dominant_color.histogram_8 +
                         # dominant_color.histogram_9 +
                         # dominant_color.value +
                         face_detection.average_face2frame_ratio + 
                         face_detection.average_face_count_per_frame + 
                         face_detection.average_face_present +
                         text_detection.average_text2frame_ratio +
                         text_detection.average_text_frames +
                         shot_detection.average_shot_length + 
                         shot_detection.shots_count +
                         # shot_detection.transition_histogram_0 +
                         # shot_detection.transition_histogram_1 +
                         # other.average_movie_speed +
                         other.clutter_metric +
                         rigidity.average_rigidity,
                         data = train, method = "rf", trControl = tr)

# model_rf_crossvalidation
# 
# 
# # To check important variables
# importance(model_rf_crossvalidation$finalModel)
varImpPlot(model_rf_crossvalidation$finalModel)

# Predicting on test set
test_pred_rf_crossvalidation <- predict(model_rf_crossvalidation$finalModel, test, type = "class")

# Checking classification metrics
confusion_matrix_rf_crossvalidation <- table(test_pred_rf_crossvalidation, test$maior_1m)  
confusion_matrix_rf_crossvalidation

metrics(confusion_matrix_rf_crossvalidation)

```

### Paper technique

```{r paper-technique2}

# Support Vector Machine Radial
model_cv_svm_radial <- train(maior_1m ~ 
                         general.duration +
                         general.fps +
                         general.frame_count +
                         general.frame_size.height +
                         # dominant_color.histogram_0 +
                         # dominant_color.histogram_1 +
                         # dominant_color.histogram_2 +
                         dominant_color.histogram_3 +
                         # dominant_color.histogram_4 +
                         # dominant_color.histogram_5 +
                         # dominant_color.histogram_6 +
                         dominant_color.histogram_7 +
                         # dominant_color.histogram_8 +
                         # dominant_color.histogram_9 +
                         # dominant_color.value +
                         face_detection.average_face2frame_ratio + 
                         face_detection.average_face_count_per_frame + 
                         face_detection.average_face_present +
                         text_detection.average_text2frame_ratio +
                         text_detection.average_text_frames +
                         shot_detection.average_shot_length + 
                         shot_detection.shots_count +
                         # shot_detection.transition_histogram_0 + 
                         # shot_detection.transition_histogram_1 +
                         # other.average_movie_speed +
                         other.clutter_metric +
                         rigidity.average_rigidity,
                         data = train, method = "svmRadial", trControl = tr)

# model_cv_svm_radial


# Predicting o test set
test_pred_svm_radial <- predict(model_cv_svm_radial, test)

# Checking classification metrics
confusion_matrix_svm_radial <- confusionMatrix(test_pred_svm_radial, test$maior_1m)
confusion_matrix_svm_radial

metrics(as.matrix(confusion_matrix_svm_radial$table))


```

### Other models

Ajustando outros modelos de machine larning para comparação.

```{r cross-validation-outros2}
# Support Vector Machine Linear
model_cv_svm_linear <- train(maior_1m ~ 
                         general.duration +
                         general.fps +
                         general.frame_count +
                         general.frame_size.height +
                         # dominant_color.histogram_0 +
                         # dominant_color.histogram_1 +
                         # dominant_color.histogram_2 +
                         dominant_color.histogram_3 +
                         # dominant_color.histogram_4 +
                         # dominant_color.histogram_5 +
                         # dominant_color.histogram_6 +
                         dominant_color.histogram_7 +
                         # dominant_color.histogram_8 +
                         # dominant_color.histogram_9 +
                         # dominant_color.value +
                         face_detection.average_face2frame_ratio + 
                         face_detection.average_face_count_per_frame + 
                         face_detection.average_face_present +
                         text_detection.average_text2frame_ratio +
                         text_detection.average_text_frames +
                         shot_detection.average_shot_length + 
                         shot_detection.shots_count +
                         # shot_detection.transition_histogram_0 + 
                         # shot_detection.transition_histogram_1 +
                         # other.average_movie_speed +
                         other.clutter_metric +
                         rigidity.average_rigidity,
                         data = train, method = "svmLinear", trControl = tr)

# model_cv_svm_linear

# Predicting on test set
test_pred_svm_linear <- predict(model_cv_svm_linear, test)
# Checking classification metrics

confusion_matrix_svm_linear <- confusionMatrix(test_pred_svm_linear, test$maior_1m)
confusion_matrix_svm_linear

metrics(as.matrix(confusion_matrix_svm_linear$table))

```



### WITHOUT Variable selection

A princípio, o modelo default que mais se saiu bem foi o que utiliza a variável resposta como sendo o vídeo ter mais de 1 milhão de views.

Abaixo o teste fazendo uma seleção manual de variáveis.

```{r random-forests-testing22}

# Create a Random Forest model with default parameters
model_rf_selection <- randomForest(maior_1m ~ 
                         general.duration +
                         general.fps +
                         general.frame_count +
                         general.frame_size.height+
                         dominant_color.histogram_0 +
                         dominant_color.histogram_1 +
                         dominant_color.histogram_2 +
                         dominant_color.histogram_3 +
                         dominant_color.histogram_4 +
                         dominant_color.histogram_5 +
                         dominant_color.histogram_6 +
                         dominant_color.histogram_7 +
                         dominant_color.histogram_8 +
                         dominant_color.histogram_9 +
                         dominant_color.value +
                         face_detection.average_face2frame_ratio + 
                         face_detection.average_face_count_per_frame + 
                         face_detection.average_face_present+
                         text_detection.average_text2frame_ratio +
                         text_detection.average_text_frames+
                         shot_detection.average_shot_length + 
                         shot_detection.shots_count +
                         shot_detection.transition_histogram_0 +
                         shot_detection.transition_histogram_1 +
                         other.average_movie_speed +
                         other.clutter_metric +
                         rigidity.average_rigidity, data = train, 
                         importance = TRUE, mtry = 6)
# model_rf_selection
# 
# # To check important variables
# importance(model_rf_selection)
# varImpPlot(model_rf_selection)

# Predicting on test set
test_pred_rf_selecion <- predict(model_rf_selection, test, type = "class")

# Checking classification metrics
confusion_matrix_rf_selecion <- table(test_pred_rf_selecion, test$maior_1m)
confusion_matrix_rf_selecion

metrics(confusion_matrix_rf_selecion)
```

## Cross validation

Agora, tunando o parâmetro mtry da Random Forest e utilizando croos validation com k = 5 folders.

```{r cross-validation22}

# 5 folds
tr <- trainControl(method = "cv", number = 5)

model_rf_crossvalidation <- train(maior_1m ~ 
                         general.duration +
                         general.fps +
                         general.frame_count +
                         general.frame_size.height +
                         dominant_color.histogram_0 +
                         dominant_color.histogram_1 +
                         dominant_color.histogram_2 +
                         dominant_color.histogram_3 +
                         dominant_color.histogram_4 +
                         dominant_color.histogram_5 +
                         dominant_color.histogram_6 +
                         dominant_color.histogram_7 +
                         dominant_color.histogram_8 +
                         dominant_color.histogram_9 +
                         # dominant_color.value +
                         face_detection.average_face2frame_ratio + 
                         face_detection.average_face_count_per_frame + 
                         face_detection.average_face_present +
                         text_detection.average_text2frame_ratio +
                         text_detection.average_text_frames +
                         shot_detection.average_shot_length + 
                         shot_detection.shots_count +
                         shot_detection.transition_histogram_0 +
                         shot_detection.transition_histogram_1 +
                         other.average_movie_speed +
                         other.clutter_metric +
                         rigidity.average_rigidity,
                         data = train, method = "rf", trControl = tr)

# model_rf_crossvalidation
# 
# 
# # To check important variables
# importance(model_rf_crossvalidation$finalModel)
varImpPlot(model_rf_crossvalidation$finalModel)

# Predicting on test set
test_pred_rf_crossvalidation <- predict(model_rf_crossvalidation$finalModel, test, type = "class")

# Checking classification metrics
confusion_matrix_rf_crossvalidation <- table(test_pred_rf_crossvalidation, test$maior_1m)  
confusion_matrix_rf_crossvalidation

metrics(confusion_matrix_rf_crossvalidation)

```

### Paper technique

```{r paper-technique22}

# Support Vector Machine Radial
model_cv_svm_radial <- train(maior_1m ~ 
                         general.duration +
                         general.fps +
                         general.frame_count +
                         general.frame_size.height +
                         dominant_color.histogram_0 +
                         dominant_color.histogram_1 +
                         dominant_color.histogram_2 +
                         dominant_color.histogram_3 +
                         dominant_color.histogram_4 +
                         dominant_color.histogram_5 +
                         dominant_color.histogram_6 +
                         dominant_color.histogram_7 +
                         dominant_color.histogram_8 +
                         dominant_color.histogram_9 +
                         # dominant_color.value +
                         face_detection.average_face2frame_ratio + 
                         face_detection.average_face_count_per_frame + 
                         face_detection.average_face_present +
                         text_detection.average_text2frame_ratio +
                         text_detection.average_text_frames +
                         shot_detection.average_shot_length + 
                         shot_detection.shots_count +
                         shot_detection.transition_histogram_0 +
                         shot_detection.transition_histogram_1 +
                         other.average_movie_speed +
                         other.clutter_metric +
                         rigidity.average_rigidity,
                         data = train, method = "svmRadial", trControl = tr)

# model_cv_svm_radial


# Predicting o test set
test_pred_svm_radial <- predict(model_cv_svm_radial, test)

# Checking classification metrics
confusion_matrix_svm_radial <- confusionMatrix(test_pred_svm_radial, test$maior_1m)
confusion_matrix_svm_radial

metrics(as.matrix(confusion_matrix_svm_radial$table))


```

### Other models

Ajustando outros modelos de machine larning para comparação.

```{r cross-validation-outros22}
# Support Vector Machine Linear
model_cv_svm_linear <- train(maior_1m ~ 
                         general.duration +
                         general.fps +
                         general.frame_count +
                         general.frame_size.height +
                         dominant_color.histogram_0 +
                         dominant_color.histogram_1 +
                         dominant_color.histogram_2 +
                         dominant_color.histogram_3 +
                         dominant_color.histogram_4 +
                         dominant_color.histogram_5 +
                         dominant_color.histogram_6 +
                         dominant_color.histogram_7 +
                         dominant_color.histogram_8 +
                         dominant_color.histogram_9 +
                         dominant_color.value +
                         face_detection.average_face2frame_ratio + 
                         face_detection.average_face_count_per_frame + 
                         face_detection.average_face_present +
                         text_detection.average_text2frame_ratio +
                         text_detection.average_text_frames +
                         shot_detection.average_shot_length + 
                         shot_detection.shots_count +
                         shot_detection.transition_histogram_0 +
                         shot_detection.transition_histogram_1 +
                         other.average_movie_speed +
                         other.clutter_metric +
                         rigidity.average_rigidity,
                         data = train, method = "svmLinear", trControl = tr)

# model_cv_svm_linear

# Predicting on test set
test_pred_svm_linear <- predict(model_cv_svm_linear, test)
# Checking classification metrics

confusion_matrix_svm_linear <- confusionMatrix(test_pred_svm_linear, test$maior_1m)
confusion_matrix_svm_linear

metrics(as.matrix(confusion_matrix_svm_linear$table))

```





# Rascunho:

## Links R:

Modelagem:
http://www.est.ufmg.br/portal/arquivos/rts/RT-SE-2009.pdf

Random Forest:
https://www.r-bloggers.com/how-to-implement-random-forests-in-r/

PCA:
http://www.sthda.com/english/articles/31-principal-component-methods-in-r-practical-guide/118-principal-component-analysis-in-r-prcomp-vs-princomp/